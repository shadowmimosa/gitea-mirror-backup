# ============================================================
# Gitea Mirror Backup - Docker Compose é…ç½®æ–‡ä»¶
# ============================================================
# 
# ğŸ“– å¿«é€Ÿå¼€å§‹ï¼š
#   1. ä¿®æ”¹ volumes.gitea-data.driver_opts.device ä¸ºå®é™…è·¯å¾„
#   2. å¤åˆ¶ .env.example ä¸º .env å¹¶ä¿®æ”¹é…ç½®
#      cp env.example .env
#   3. å¤åˆ¶ config/config.yaml å¹¶æ ¹æ®éœ€è¦ä¿®æ”¹
#      cp config.example.yaml config/config.yaml
#   4. é€‰æ‹©è¿è¡Œæ¨¡å¼ï¼š
#      - æ‰‹åŠ¨å¤‡ä»½ï¼šdocker compose run --rm backup
#      - å¯åŠ¨ Webï¼šdocker compose up -d web
#      - å¯åŠ¨å®šæ—¶ï¼šdocker compose up -d cron
#      - å…¨éƒ¨å¯åŠ¨ï¼šdocker compose --profile full up -d
#
# ğŸ“š è¯¦ç»†æ–‡æ¡£ï¼š
#   - é…ç½®è¯´æ˜ï¼šdocs/configuration.md
#   - é…ç½®åˆ†æï¼šdocs/configuration-analysis.md
#   - Docker æŒ‡å—ï¼šdocs/docker.md
#   - ä¸»æ–‡æ¡£ï¼šREADME_CN.md
#
# âš ï¸ é‡è¦æç¤ºï¼š
#   - docker compose up ä¸ä¼šå¯åŠ¨ä»»ä½•æœåŠ¡ï¼ˆè¿™æ˜¯è®¾è®¡è¡Œä¸ºï¼‰
#   - æ‰€æœ‰æœåŠ¡éƒ½ä½¿ç”¨ profilesï¼Œéœ€è¦æ˜ç¡®æŒ‡å®šæ‰ä¼šå¯åŠ¨
#   - é…ç½®ä¼˜å…ˆçº§ï¼š.env ç¯å¢ƒå˜é‡ > config.yaml > é»˜è®¤å€¼
#
# ============================================================

# ============================================================
# å…±äº«å·å®šä¹‰
# è¯´æ˜ï¼šä½¿ç”¨ bind æŒ‚è½½æ–¹å¼ï¼Œä½¿å¤‡ä»½æ—¶çš„ç¡¬é“¾æ¥åŠŸèƒ½ç”Ÿæ•ˆ
# ============================================================
volumes:
  gitea-data:
    driver: local
    driver_opts:
      type: none      # ä½¿ç”¨ bind æŒ‚è½½è€Œé volume
      o: bind
      device: /opt/gitea       # ã€é‡è¦ã€‘ä¿®æ”¹ä¸ºå®¿ä¸»æœºä¸Šçš„å®é™…è·¯å¾„
                               # æ­¤ç›®å½•åº”åŒ…å«ä¸¤ä¸ªå­ç›®å½•ï¼š
                               # - gitea/     (Gitea æ•°æ®ç›®å½•)
                               # - backup/    (å¤‡ä»½å­˜å‚¨ç›®å½•)

# ============================================================
# å…±äº«ç¯å¢ƒå˜é‡é…ç½®
# è¯´æ˜ï¼šåŸºç¡€é…ç½®ï¼Œæ›´å¤šé…ç½®è¯·åœ¨ .env æ–‡ä»¶æˆ– config/config.yaml ä¸­è®¾ç½®
# ============================================================
x-common-env: &common-env
  # æ—¶åŒºè®¾ç½®
  TZ: Asia/Shanghai

# ============================================================
# å…±äº«å·æŒ‚è½½é…ç½®
# è¯´æ˜ï¼šè¿™äº›å·ä¼šè¢«æ‰€æœ‰å¤‡ä»½ç›¸å…³æœåŠ¡å…±äº«
# ============================================================
x-common-volumes: &common-volumes
  # å…±äº«æ•°æ®å·ï¼ˆåŒ…å« Gitea æ•°æ®å’Œå¤‡ä»½ç›®å½•ï¼‰
  - gitea-data:/shared:rw
  
  # æ—¥å¿—ç›®å½•ï¼ˆå®¿ä¸»æœºè·¯å¾„ï¼Œç”¨äºæŒä¹…åŒ–æ—¥å¿—ï¼‰
  - /var/log/gitea-backup:/logs:rw
  
  # Docker socketï¼ˆç”¨äºä¸ Docker å®ˆæŠ¤è¿›ç¨‹é€šä¿¡ï¼Œæ£€æŸ¥å®¹å™¨çŠ¶æ€ï¼‰
  - /var/run/docker.sock:/var/run/docker.sock:ro
  
  # é…ç½®ç›®å½•æŒ‚è½½ï¼ˆæ¨èä½¿ç”¨ config.yaml ç®¡ç†å¤æ‚é…ç½®ï¼‰
  - ./config:/app/config:ro

services:
  # ============================================================
  # å¤‡ä»½æœåŠ¡ - ä¸€æ¬¡æ€§ä»»åŠ¡
  # ç”¨é€”ï¼šæ‰‹åŠ¨æ‰§è¡Œå¤‡ä»½ä»»åŠ¡ï¼Œæ‰§è¡Œå®Œæˆåè‡ªåŠ¨é€€å‡º
  # ä½¿ç”¨ï¼šdocker compose run --rm backup
  # ============================================================
  backup:
    build:
      context: .
      dockerfile: Dockerfile
    image: gitea-mirror-backup:latest
    container_name: gitea-backup-oneshot
    environment:
      <<: *common-env
    env_file:
      - .env  # ä» .env æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡
    volumes: *common-volumes
    network_mode: bridge
    # ä¸è®¾ç½® restartï¼Œå› ä¸ºè¿™æ˜¯ä¸€æ¬¡æ€§ä»»åŠ¡
    # ä½¿ç”¨ profiles é˜²æ­¢ docker compose up æ—¶è‡ªåŠ¨å¯åŠ¨
    profiles:
      - manual
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Web ç®¡ç†ç•Œé¢ - å¯é€‰æœåŠ¡
  # ç”¨é€”ï¼šæä¾› Web ç•Œé¢æŸ¥çœ‹å¤‡ä»½å†å²ã€çŠ¶æ€å’Œæ‰‹åŠ¨è§¦å‘å¤‡ä»½
  # å¯åŠ¨ï¼šdocker compose up -d web
  # è®¿é—®ï¼šhttp://localhost:8000
  # ============================================================
  web:
    build:
      context: .
      dockerfile: Dockerfile.web
    image: gitea-mirror-backup-web:latest
    container_name: gitea-backup-web
    ports:
      - "8010:8000"  # ã€å¯ä¿®æ”¹ã€‘å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£
    environment:
      <<: *common-env
      # å¤‡ä»½æ•°æ®è·¯å¾„ï¼ˆå®¹å™¨å†…ï¼Œä¸å¤‡ä»½æœåŠ¡ä¿æŒä¸€è‡´ï¼‰
      BACKUP_ROOT: /shared/backup
      # Web æ•°æ®åº“è·¯å¾„
      DATABASE_URL: sqlite:///data/web.db
      # é…ç½®æ–‡ä»¶è·¯å¾„
      BACKUP_CONFIG_PATH: /app/config/config.yaml
    env_file:
      - .env  # ä» .env æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡ï¼ˆåŒ…å« SECRET_KEYï¼‰
    volumes:
      - gitea-data:/shared:ro  # åªè¯»è®¿é—®å¤‡ä»½æ•°æ®ï¼ˆå®‰å…¨ï¼‰
      - ./config:/app/config:ro
      - ./web/data:/app/data   # Web æ•°æ®åº“æŒä¹…åŒ–
    restart: unless-stopped
    # ä½¿ç”¨ profiles é˜²æ­¢é»˜è®¤å¯åŠ¨
    profiles:
      - web
      - full
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # å®šæ—¶ä»»åŠ¡æœåŠ¡ - å¯é€‰æœåŠ¡
  # ç”¨é€”ï¼šè‡ªåŠ¨å®šæ—¶æ‰§è¡Œå¤‡ä»½ä»»åŠ¡
  # é»˜è®¤ï¼šæ¯å¤©å‡Œæ™¨ 2 ç‚¹æ‰§è¡Œ
  # å¯åŠ¨ï¼šdocker compose up -d cron
  # ä¿®æ”¹æ—¶é—´ï¼šç¼–è¾‘ä¸‹é¢çš„ cron è¡¨è¾¾å¼ï¼ˆ0 2 * * *ï¼‰
  # ============================================================
  cron:
    image: gitea-mirror-backup:latest
    container_name: gitea-backup-cron
    entrypoint: /bin/sh
    # Cron è¡¨è¾¾å¼è¯´æ˜ï¼šåˆ† æ—¶ æ—¥ æœˆ å‘¨
    # 0 2 * * * = æ¯å¤©å‡Œæ™¨ 2:00
    # 0 */6 * * * = æ¯ 6 å°æ—¶ä¸€æ¬¡
    # 0 0 * * 0 = æ¯å‘¨æ—¥å‡Œæ™¨
    command: -c "printenv | grep -v 'no_proxy' >> /etc/environment && echo '0 2 * * * . /etc/environment && cd /app && /usr/local/bin/python3 gitea_mirror_backup.py >> /logs/cron.log 2>&1' | crontab - && cron -f"
    environment:
      <<: *common-env
    env_file:
      - .env  # ä» .env æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡
    volumes: *common-volumes
    restart: unless-stopped
    # ä½¿ç”¨ profiles é˜²æ­¢é»˜è®¤å¯åŠ¨
    profiles:
      - cron
      - full
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

