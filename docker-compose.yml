# ============================================================
# Gitea Mirror Backup - Docker Compose 配置文件
# ============================================================
# 
# 📖 快速开始：
#   1. 修改下面的 volumes.gitea-data.driver_opts.device 为实际路径
#   2. 根据需要修改环境变量配置（x-common-env 部分）
#   3. 选择运行模式：
#      - 手动备份：docker compose run --rm backup
#      - 启动 Web：docker compose up -d web
#      - 启动定时：docker compose up -d cron
#      - 全部启动：docker compose --profile full up -d
#
# 📚 详细文档：
#   - 配置说明：docs/configuration.md
#   - Docker 指南：docs/docker.md
#   - 主文档：README_CN.md
#
# ⚠️ 重要提示：
#   - docker compose up 不会启动任何服务（这是设计行为）
#   - 所有服务都使用 profiles，需要明确指定才会启动
#   - 配置优先级：环境变量 > config.yaml > 默认值
#
# ============================================================

# ============================================================
# 共享卷定义
# 说明：使用 bind 挂载方式，使备份时的硬链接功能生效
# ============================================================
volumes:
  gitea-data:
    driver: local
    driver_opts:
      type: none      # 使用 bind 挂载而非 volume
      o: bind
      device: /opt/gitea       # 【重要】修改为宿主机上的实际路径
                               # 此目录应包含两个子目录：
                               # - gitea/     (Gitea 数据目录)
                               # - backup/    (备份存储目录)

# ============================================================
# 共享环境变量配置
# 说明：这些配置会被所有服务共享，可根据实际情况修改
# ============================================================
x-common-env: &common-env
  # 时区设置（中国时区）
  TZ: Asia/Shanghai
  
  # ============ Gitea 配置 ============
  # Gitea 容器名称（需要与实际运行的 Gitea 容器名一致）
  GITEA_DOCKER_CONTAINER: gitea
  
  # Gitea 数据目录（容器内路径，对应共享卷中的 gitea 子目录）
  GITEA_DATA_VOLUME: /shared/gitea
  
  # ============ 备份配置 ============
  # 备份存储根目录（容器内路径，对应共享卷中的 backup 子目录）
  BACKUP_ROOT: /shared/backup
  
  # 要备份的组织列表（逗号分隔，留空表示备份所有组织）
  # 示例: "Org1,Org2,Org3"
  BACKUP_ORGANIZATIONS: ""
  
  # 是否只备份镜像仓库（true=只备份镜像仓库，false=备份所有仓库）
  CHECK_MIRROR_ONLY: "false"
  
  # ============ 保留策略 ============
  # 快照保留天数（超过此天数的快照会被清理）
  SNAPSHOT_RETENTION_DAYS: "30"
  
  # 归档保留月数（超过此月数的归档会被清理）
  ARCHIVE_RETENTION_MONTHS: "12"
  
  # 报告保留天数（超过此天数的报告会被清理）
  REPORT_RETENTION_DAYS: "30"
  
  # ============ 异常检测 ============
  # 提交数减少阈值（百分比，超过此值会触发警告）
  # 示例: 10 表示提交数减少超过 10% 时警告
  COMMIT_DECREASE_THRESHOLD: "10"
  
  # 仓库大小减少阈值（百分比，超过此值会触发警告）
  # 示例: 30 表示大小减少超过 30% 时警告
  SIZE_DECREASE_THRESHOLD: "30"
  
  # 是否保护异常快照（true=检测到异常时不删除旧快照，false=正常清理）
  PROTECT_ABNORMAL_SNAPSHOTS: "true"
  
  # ============ 日志配置 ============
  # 日志文件路径（容器内路径）
  LOG_FILE: /logs/gitea-mirror-backup.log
  
  # 日志级别（DEBUG, INFO, WARNING, ERROR）
  LOG_LEVEL: INFO
  
  # ============ 通知配置（可选） ============
  # Webhook 通知 URL（企业微信、钉钉等）
  # 取消注释并填入实际 URL 以启用通知
  # WEBHOOK_URL: https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=your-key-here
  
  # 通知触发时机（always=总是通知, on_alert=仅异常时通知, never=不通知）
  # WEBHOOK_NOTIFY_ON: on_alert

# ============================================================
# 共享卷挂载配置
# 说明：这些卷会被所有备份相关服务共享
# ============================================================
x-common-volumes: &common-volumes
  # 共享数据卷（包含 Gitea 数据和备份目录）
  - gitea-data:/shared:rw
  
  # 日志目录（宿主机路径，用于持久化日志）
  - /var/log/gitea-backup:/logs:rw
  
  # Docker socket（用于与 Docker 守护进程通信，检查容器状态）
  - /var/run/docker.sock:/var/run/docker.sock:ro
  
  # ============ 可选：配置文件挂载 ============
  # 如果你想使用 config.yaml 而非环境变量，取消下面的注释
  # 注意：环境变量优先级高于配置文件
  # - ./config.yaml:/app/config.yaml:ro

services:
  # ============================================================
  # 备份服务 - 一次性任务
  # 用途：手动执行备份任务，执行完成后自动退出
  # 使用：docker compose run --rm backup
  # ============================================================
  backup:
    build:
      context: .
      dockerfile: Dockerfile
    image: gitea-mirror-backup:latest
    container_name: gitea-backup-oneshot
    environment:
      <<: *common-env
    volumes: *common-volumes
    network_mode: bridge
    # 不设置 restart，因为这是一次性任务
    # 使用 profiles 防止 docker compose up 时自动启动
    profiles:
      - manual
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Web 管理界面 - 可选服务
  # 用途：提供 Web 界面查看备份历史、状态和手动触发备份
  # 启动：docker compose up -d web
  # 访问：http://localhost:8000
  # ============================================================
  web:
    build:
      context: .
      dockerfile: Dockerfile.web
    image: gitea-mirror-backup-web:latest
    container_name: gitea-backup-web
    ports:
      - "8010:8000"  # 【可修改】宿主机端口:容器端口
    environment:
      - TZ=Asia/Shanghai
      # 【重要】生产环境请修改此密钥
      - SECRET_KEY=${SECRET_KEY:-change-this-secret-key-in-production}
      # Web 数据库路径
      - DATABASE_URL=sqlite:///data/web.db
      # 备份数据路径（容器内）
      - BACKUP_BASE_PATH=/shared/backup
      # 配置文件路径（可选）
      - BACKUP_CONFIG_PATH=/app/config/config.yaml
    volumes:
      - gitea-data:/shared:ro  # 只读访问备份数据（安全）
      - ./config:/app/config:ro
      - ./web/data:/app/data   # Web 数据库持久化
    restart: unless-stopped
    # 使用 profiles 防止默认启动
    profiles:
      - web
      - full
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # 定时任务服务 - 可选服务
  # 用途：自动定时执行备份任务
  # 默认：每天凌晨 2 点执行
  # 启动：docker compose up -d cron
  # 修改时间：编辑下面的 cron 表达式（0 2 * * *）
  # ============================================================
  cron:
    image: gitea-mirror-backup:latest
    container_name: gitea-backup-cron
    entrypoint: /bin/sh
    # Cron 表达式说明：分 时 日 月 周
    # 0 2 * * * = 每天凌晨 2:00
    # 0 */6 * * * = 每 6 小时一次
    # 0 0 * * 0 = 每周日凌晨
    command: -c "printenv | grep -v 'no_proxy' >> /etc/environment && echo '0 2 * * * . /etc/environment && cd /app && /usr/local/bin/python3 gitea_mirror_backup.py >> /logs/cron.log 2>&1' | crontab - && cron -f"
    environment:
      <<: *common-env
    volumes: *common-volumes
    restart: unless-stopped
    # 使用 profiles 防止默认启动
    profiles:
      - cron
      - full
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

