version: '3.8'

# 定义共享卷（推荐方式 - 使硬链接生效）
volumes:
  gitea-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/gitea-data  # 宿主机上的实际路径

services:
  gitea-backup:
    build:
      context: .
      dockerfile: Dockerfile
    image: gitea-mirror-backup:latest
    container_name: gitea-backup
    
    # 环境变量配置
    environment:
      # 时区设置
      - TZ=Asia/Shanghai
      
      # Gitea 配置
      - GITEA_DOCKER_CONTAINER=gitea
      - GITEA_DATA_VOLUME=/shared/gitea  # 改为共享卷下的子目录
      
      # 备份配置
      - BACKUP_ROOT=/shared/backup  # 改为共享卷下的子目录
      - BACKUP_ORGANIZATIONS=
      - CHECK_MIRROR_ONLY=false
      
      # 保留策略
      - SNAPSHOT_RETENTION_DAYS=30
      - ARCHIVE_RETENTION_MONTHS=12
      - REPORT_RETENTION_DAYS=30
      
      # 异常检测
      - COMMIT_DECREASE_THRESHOLD=10
      - SIZE_DECREASE_THRESHOLD=30
      - PROTECT_ABNORMAL_SNAPSHOTS=true
      
      # 日志配置
      - LOG_FILE=/logs/gitea-mirror-backup.log
      - LOG_LEVEL=INFO
      
      # 通知配置（可选）
      # - WEBHOOK_URL=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx
      # - WEBHOOK_NOTIFY_ON=on_alert
    
    # 卷挂载 - 使用共享卷（支持硬链接）
    volumes:
      # 配置文件（可选）
      - ./config.yaml:/app/config.yaml:ro
      
      # 使用同一个卷挂载到 /shared，Gitea 数据和备份都在这个卷下
      - gitea-data:/shared:rw  # 共享卷，包含 gitea/ 和 backup/ 子目录
      
      # 日志目录
      - /var/log/gitea-backup:/logs:rw
      
      # Docker socket
      - /var/run/docker.sock:/var/run/docker.sock:ro
    
    # 网络模式
    network_mode: bridge
    
    # 重启策略 - 改为 no，执行一次后退出
    restart: "no"
    
    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    
    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# 可选：定时任务服务
  gitea-backup-cron:
    image: gitea-mirror-backup:latest
    container_name: gitea-backup-cron
    
    # 使用 cron 定时执行
    entrypoint: /bin/sh
    command: -c "echo '0 2 * * * cd /app && python gitea_mirror_backup.py >> /logs/cron.log 2>&1' | crontab - && cron -f"
    
    environment:
      - TZ=Asia/Shanghai
      - GITEA_DOCKER_CONTAINER=gitea
      - GITEA_DATA_VOLUME=/shared/gitea
      - BACKUP_ROOT=/shared/backup
      - LOG_FILE=/logs/gitea-mirror-backup.log
      - LOG_LEVEL=INFO
    
    volumes:
      - ./config.yaml:/app/config.yaml:ro
      - gitea-data:/shared:rw
      - /var/log/gitea-backup:/logs:rw
      - /var/run/docker.sock:/var/run/docker.sock:ro
    
    restart: unless-stopped
    
    profiles:
      - cron

