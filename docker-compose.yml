version: '3.8'

# 定义共享卷（推荐方式 - 使硬链接生效）
volumes:
  gitea-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/gitea-data  # 宿主机上的实际路径

# 共享环境变量配置
x-common-env: &common-env
  TZ: Asia/Shanghai
  GITEA_DOCKER_CONTAINER: gitea
  GITEA_DATA_VOLUME: /shared/gitea
  BACKUP_ROOT: /shared/backup
  BACKUP_ORGANIZATIONS: ""
  CHECK_MIRROR_ONLY: "false"
  SNAPSHOT_RETENTION_DAYS: "30"
  ARCHIVE_RETENTION_MONTHS: "12"
  REPORT_RETENTION_DAYS: "30"
  COMMIT_DECREASE_THRESHOLD: "10"
  SIZE_DECREASE_THRESHOLD: "30"
  PROTECT_ABNORMAL_SNAPSHOTS: "true"
  LOG_FILE: /logs/gitea-mirror-backup.log
  LOG_LEVEL: INFO
  # 通知配置（可选）
  # WEBHOOK_URL: https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx
  # WEBHOOK_NOTIFY_ON: on_alert

# 共享卷挂载配置（列表类型的锚点）
x-common-volumes: &common-volumes
  - gitea-data:/shared:rw
  - /var/log/gitea-backup:/logs:rw
  - /var/run/docker.sock:/var/run/docker.sock:ro
  # config.yaml 是可选的，如果需要则在各服务中单独添加
  # - ./config.yaml:/app/config.yaml:ro

services:
  # 备份服务 - 仅用于手动执行：docker compose run --rm backup
  backup:
    build:
      context: .
      dockerfile: Dockerfile
    image: gitea-mirror-backup:latest
    container_name: gitea-backup-oneshot
    environment:
      <<: *common-env
    volumes: *common-volumes
    network_mode: bridge
    # 不设置 restart，因为这是一次性任务
    # 使用 profiles 防止 docker compose up 时自动启动
    profiles:
      - manual
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Web 管理界面 - 可选服务
  web:
    build:
      context: .
      dockerfile: Dockerfile.web
    image: gitea-mirror-backup-web:latest
    container_name: gitea-backup-web
    ports:
      - "8000:8000"
    environment:
      - TZ=Asia/Shanghai
      - SECRET_KEY=${SECRET_KEY:-change-this-secret-key-in-production}
      - DATABASE_URL=sqlite:///data/web.db
      - BACKUP_BASE_PATH=/shared/backup
      - BACKUP_CONFIG_PATH=/app/config/config.yaml
    volumes:
      - gitea-data:/shared:ro  # 只读访问备份数据
      - ./config:/app/config:ro
      - ./web/data:/app/data
    restart: unless-stopped
    # 使用 profiles 防止默认启动
    profiles:
      - web
      - full
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # 定时任务服务 - 可选服务
  cron:
    image: gitea-mirror-backup:latest
    container_name: gitea-backup-cron
    entrypoint: /bin/sh
    command: -c "echo '0 2 * * * cd /app && /usr/local/bin/python gitea_mirror_backup.py >> /logs/cron.log 2>&1' | crontab - && cron -f"
    environment:
      <<: *common-env
    volumes: *common-volumes
    restart: unless-stopped
    # 使用 profiles 防止默认启动
    profiles:
      - cron
      - full
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

