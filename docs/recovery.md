# æ¢å¤è„šæœ¬ä½¿ç”¨ç¤ºä¾‹

æœ¬æ–‡æ¡£å±•ç¤ºå¦‚ä½•ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„ `restore.sh` æ¢å¤è„šæœ¬ã€‚

## æ¢å¤è„šæœ¬ä½ç½®

æ¯ä¸ªå¤‡ä»½çš„ä»“åº“éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ¢å¤è„šæœ¬ï¼š

```
/backup/gitea-mirrors/
â””â”€â”€ myorg/
    â””â”€â”€ myrepo/
        â”œâ”€â”€ snapshots/          # å¿«ç…§ç›®å½•
        â”‚   â”œâ”€â”€ 20260124-020000/
        â”‚   â”œâ”€â”€ 20260123-020000/
        â”‚   â””â”€â”€ ...
        â”œâ”€â”€ archives/           # å½’æ¡£ç›®å½•
        â””â”€â”€ restore.sh          # æ¢å¤è„šæœ¬ â† è¿™ä¸ªï¼
```

## è¿è¡Œæ¢å¤è„šæœ¬

```bash
# æ‰§è¡Œæ¢å¤è„šæœ¬
/backup/gitea-mirrors/myorg/myrepo/restore.sh
```

## äº¤äº’å¼æ¢å¤æµç¨‹

### æ­¥éª¤ 1: é€‰æ‹©å¿«ç…§

```
==========================================
Gitea é•œåƒä»“åº“æ¢å¤å·¥å…·
==========================================
ä»“åº“: myorg/myrepo

å¯ç”¨çš„å¿«ç…§:
  [1] 20260124-020000
      timestamp=2026-01-24T02:00:00.123456
  [2] 20260123-020000
      timestamp=2026-01-23T02:00:00.123456
  [3] 20260122-020000
      timestamp=2026-01-22T02:00:00.123456

æ¢å¤é€‰é¡¹:
  1) æ¢å¤åˆ°åŸä»“åº“ä½ç½®ï¼ˆä¼šè¦†ç›–ç°æœ‰ä»“åº“ï¼‰
  2) å¯¼å‡ºä¸ºæ–°ä»“åº“ï¼ˆä¸å½±å“åŸä»“åº“ï¼‰
  3) å¯¼å‡ºä¸º Git Bundle æ–‡ä»¶

é€‰æ‹©æ¢å¤æ–¹å¼ [1]:
```

### æ­¥éª¤ 2: é€‰æ‹©å¿«ç…§ç¼–å·

```
é€‰æ‹©è¦æ¢å¤çš„å¿«ç…§ç¼–å· [1]: 2
```

## æ¢å¤æ¨¡å¼è¯¦è§£

### æ¨¡å¼ 1: æ¢å¤åˆ°åŸä½ç½®

**é€‚ç”¨åœºæ™¯**ï¼š
- æºä»“åº“å·²ä¿®å¤ï¼Œéœ€è¦åŒæ­¥å›æ¥
- ä¸´æ—¶æŸ¥çœ‹å†å²ç‰ˆæœ¬
- éé•œåƒä»“åº“

**æ³¨æ„äº‹é¡¹**ï¼š
- âš ï¸ ä¼šè¦†ç›–ç°æœ‰ä»“åº“
- âš ï¸ é•œåƒä»“åº“ä¸‹æ¬¡åŒæ­¥å¯èƒ½å†æ¬¡è¢«è¦†ç›–
- âœ… è‡ªåŠ¨å¤‡ä»½å½“å‰ç‰ˆæœ¬åˆ° `.backup-æ—¶é—´æˆ³`
- âœ… è‡ªåŠ¨ä¿®å¤æ–‡ä»¶æƒé™å’Œ Git hooks

**æ‰§è¡Œæµç¨‹**ï¼š
```
é€‰æ‹©æ¢å¤æ–¹å¼ [1]: 1
é€‰æ‹©è¦æ¢å¤çš„å¿«ç…§ç¼–å· [1]: 2

å·²é€‰æ‹©å¿«ç…§: 20260123-020000

âš ï¸  è­¦å‘Š: æ­¤æ“ä½œå°†è¦†ç›–å®¹å™¨ä¸­çš„åŸä»“åº“
âš ï¸  æ³¨æ„: å¦‚æœè¿™æ˜¯é•œåƒä»“åº“ï¼Œä¸‹æ¬¡åŒæ­¥æ—¶å¯èƒ½å†æ¬¡è¢«æºä»“åº“è¦†ç›–
ç¡®è®¤ç»§ç»­? (yes/NO): yes

æ­£åœ¨æ¢å¤åˆ°åŸä½ç½®...
1. åœæ­¢ Docker å®¹å™¨...
2. å¤‡ä»½å½“å‰ä»“åº“åˆ°: /path/to/repo.git.backup-20260124-143000
3. æ¢å¤å¿«ç…§...
4. ä¿®å¤æ–‡ä»¶æƒé™...
5. å¯åŠ¨ Docker å®¹å™¨...
6. æ›´æ–°ä»“åº“ä¿¡æ¯...

âœ“ æ¢å¤å®Œæˆ!

å¦‚éœ€å›æ»šï¼Œå½“å‰ä»“åº“å·²å¤‡ä»½è‡³:
  /path/to/repo.git.backup-20260124-143000

éªŒè¯å‘½ä»¤:
  docker exec -u git gitea git -C /data/git/repositories/myorg/myrepo.git log --oneline -5
```

### æ¨¡å¼ 2: å¯¼å‡ºä¸ºæ–°ä»“åº“ï¼ˆæ¨èç”¨äºé•œåƒä»“åº“ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- é•œåƒä»“åº“è¢« force pushï¼Œéœ€è¦ä¿ç•™å®Œæ•´å†å²
- åˆ›å»ºç‹¬ç«‹å‰¯æœ¬ç”¨äºå¼€å‘
- ä¸æƒ³å½±å“åŸä»“åº“

**ä¼˜åŠ¿**ï¼š
- âœ… åŸä»“åº“ä¸å—å½±å“
- âœ… åˆ›å»ºç‹¬ç«‹çš„æ–°ä»“åº“
- âœ… è‡ªåŠ¨ç§»é™¤é•œåƒé…ç½®
- âœ… å¯ä»¥æ­£å¸¸æ¨é€æ–°ä»£ç 

**æ‰§è¡Œæµç¨‹**ï¼š
```
é€‰æ‹©æ¢å¤æ–¹å¼ [1]: 2
é€‰æ‹©è¦æ¢å¤çš„å¿«ç…§ç¼–å· [1]: 2

å·²é€‰æ‹©å¿«ç…§: 20260123-020000

å¯¼å‡ºä¸ºæ–°ä»“åº“ï¼ˆç‹¬ç«‹å‰¯æœ¬ï¼Œä¸å½±å“åŸä»“åº“ï¼‰
è¾“å…¥æ–°ä»“åº“åç§°ï¼ˆå¦‚ test-restoredï¼‰: myrepo-recovered

æ­£åœ¨å¯¼å‡ºæ–°ä»“åº“...
1. å¤åˆ¶ä»“åº“æ•°æ®...
2. ä¿®å¤æ–‡ä»¶æƒé™...
3. ç§»é™¤é•œåƒé…ç½®...

âœ“ ä»“åº“æ–‡ä»¶å·²å¯¼å‡ºå®Œæˆ!

æ–°ä»“åº“ä½ç½®: /path/to/git/repositories/myorg/myrepo-recovered.git

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ ä¸‹ä¸€æ­¥ï¼šåœ¨ Gitea ä¸­é‡‡é›†ä»“åº“

ç”±äº Gitea æ²¡æœ‰å‘½ä»¤è¡Œé‡‡é›†åŠŸèƒ½ï¼Œéœ€è¦æ‰‹åŠ¨æ“ä½œï¼š

1. ç™»å½• Gitea ç®¡ç†å‘˜è´¦å·

2. è¿›å…¥ç®¡ç†åå°ï¼š
   è®¿é—®: http://your-gitea/-/admin/repos/unadopted
   æˆ–ç‚¹å‡»: å³ä¸Šè§’å¤´åƒ -> ç®¡ç†åå° -> ä»“åº“ç®¡ç† -> æœªé‡‡é›†çš„Gitä»“åº“

3. æœç´¢ä»“åº“ï¼ˆé‡è¦ï¼åŒºåˆ†å¤§å°å†™ï¼‰ï¼š
   åœ¨æœç´¢æ¡†è¾“å…¥: myorg/myrepo-recovered
   âš ï¸  æ³¨æ„: å¿…é¡»ä½¿ç”¨å®é™…æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ï¼ˆå°å†™ï¼‰ï¼Œå¤§å°å†™æ•æ„Ÿ

4. æ‰¾åˆ°ä»“åº“åï¼Œç‚¹å‡»å³ä¾§çš„ã€Œé‡‡é›†ã€æŒ‰é’®

5. å®Œæˆï¼è®¿é—®: http://your-gitea/myorg/myrepo-recovered

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### æ¨¡å¼ 3: å¯¼å‡ºä¸º Bundle

**é€‚ç”¨åœºæ™¯**ï¼š
- éœ€è¦ä¼ è¾“ç»™å…¶ä»–äºº
- ç¦»çº¿ä¿å­˜
- åœ¨å…¶ä»–æœåŠ¡å™¨æ¢å¤

**æ‰§è¡Œæµç¨‹**ï¼š
```
é€‰æ‹©æ¢å¤æ–¹å¼ [1]: 3
é€‰æ‹©è¦æ¢å¤çš„å¿«ç…§ç¼–å· [1]: 2

å·²é€‰æ‹©å¿«ç…§: 20260123-020000

è¾“å…¥ Bundle æ–‡ä»¶ä¿å­˜è·¯å¾„ [/tmp/myorg-myrepo.bundle]: /tmp/backup.bundle

æ­£åœ¨å¯¼å‡º Git Bundle...

âœ“ å¯¼å‡ºå®Œæˆ!

Bundle æ–‡ä»¶: /tmp/backup.bundle

ä½¿ç”¨æ–¹æ³•:
  git clone /tmp/backup.bundle restored-repo
```

## éªŒè¯æ¢å¤ç»“æœ

### æ¨¡å¼ 1 éªŒè¯ï¼ˆåŸä½ç½®æ¢å¤ï¼‰

```bash
# æŸ¥çœ‹æäº¤å†å²
docker exec -u git gitea git -C /data/git/repositories/myorg/myrepo.git log --oneline -10

# æ£€æŸ¥ä»“åº“å®Œæ•´æ€§
docker exec -u git gitea git -C /data/git/repositories/myorg/myrepo.git fsck

# åœ¨ Gitea ç•Œé¢æŸ¥çœ‹
http://your-gitea/myorg/myrepo
```

### æ¨¡å¼ 2 éªŒè¯ï¼ˆæ–°ä»“åº“ï¼‰

```bash
# æŸ¥çœ‹æ–°ä»“åº“æ–‡ä»¶
ls -la /path/to/git/repositories/myorg/myrepo-recovered.git

# æŸ¥çœ‹æäº¤å†å²
docker exec -u git gitea git -C /data/git/repositories/myorg/myrepo-recovered.git log --oneline

# é‡‡é›†ååœ¨ Gitea ç•Œé¢è®¿é—®
http://your-gitea/myorg/myrepo-recovered
```

### æ¨¡å¼ 3 éªŒè¯ï¼ˆBundleï¼‰

```bash
# å…‹éš† bundle
git clone /tmp/backup.bundle test-repo
cd test-repo

# æŸ¥çœ‹å†å²
git log --oneline -10

# æ·»åŠ è¿œç¨‹ä»“åº“å¹¶æ¨é€ï¼ˆå¯é€‰ï¼‰
git remote remove origin  # ç§»é™¤ bundle æº
git remote add origin https://your-git-server/path/to/repo.git
git push -u origin main
```

## å¸¸è§é—®é¢˜

### Q: æ¢å¤å Gitea æ˜¾ç¤º "Git é’©å­å·²æŸå"

**åŸå› **: æ¢å¤åæƒé™æˆ– hooks æœªæ­£ç¡®è®¾ç½®

**è§£å†³**: è„šæœ¬ä¼šè‡ªåŠ¨æ‰§è¡Œ `update-server-info`ï¼Œä½†å¦‚æœè¿˜æœ‰é—®é¢˜ï¼š

```bash
# é‡æ–°ä¿®å¤æƒé™
docker exec gitea chown -R git:git /data/git/repositories/myorg/myrepo.git

# æ›´æ–°ä»“åº“ä¿¡æ¯
docker exec -u git gitea git -C /data/git/repositories/myorg/myrepo.git update-server-info

# é‡å¯å®¹å™¨
docker restart gitea
```

### Q: æ¨¡å¼ 2 å¯¼å‡ºååœ¨ Gitea ç•Œé¢çœ‹ä¸åˆ°

**åŸå› **: éœ€è¦æ‰‹åŠ¨é‡‡é›†ï¼Œä¸”æœç´¢**åŒºåˆ†å¤§å°å†™**

**è§£å†³**: 
1. è®¿é—® `http://your-gitea/-/admin/repos/unadopted`
2. æœç´¢å®Œæ•´è·¯å¾„ï¼ˆå°å†™ï¼‰ï¼š`myorg/myrepo-recovered`
3. ç‚¹å‡»ã€Œé‡‡é›†ã€æŒ‰é’®

### Q: æ¢å¤åæäº¤å†å²ä¸å®Œæ•´

**åŸå› **: å¯èƒ½é€‰æ‹©äº†å¼‚å¸¸åçš„å¿«ç…§

**è§£å†³**: æŸ¥çœ‹å—ä¿æŠ¤çš„å¿«ç…§ï¼Œé€‰æ‹©æœ‰ ğŸ”’ æ ‡è®°çš„ï¼š

```bash
# æŸ¥çœ‹å“ªäº›å¿«ç…§è¢«ä¿æŠ¤
find /backup/gitea-mirrors/myorg/myrepo/snapshots -name ".protected"

# æŸ¥çœ‹ä¿æŠ¤åŸå› 
cat /backup/gitea-mirrors/myorg/myrepo/snapshots/20260123-020000/.protected
```

å—ä¿æŠ¤çš„å¿«ç…§é€šå¸¸æ˜¯å¼‚å¸¸å‘ç”Ÿ**ä¹‹å‰**çš„æ­£å¸¸çŠ¶æ€ï¼ŒåŒ…å«å®Œæ•´å†å²ã€‚

## æœ€ä½³å®è·µ

1. **é•œåƒä»“åº“å‘ç”Ÿ force push**
   - ä½¿ç”¨æ¨¡å¼ 2 å¯¼å‡ºä¸ºæ–°ä»“åº“
   - è®©åŸé•œåƒç»§ç»­åŒæ­¥ï¼ˆä¿æŒæœ€æ–°ï¼‰
   - æ–°ä»“åº“ä¿ç•™å®Œæ•´å†å²ä¾›å‚è€ƒ

2. **ä¸´æ—¶æŸ¥çœ‹å†å²ç‰ˆæœ¬**
   - ä½¿ç”¨æ¨¡å¼ 3 å¯¼å‡º bundle
   - æœ¬åœ°å…‹éš†æŸ¥çœ‹
   - ä¸å½±å“æœåŠ¡å™¨

3. **æ¢å¤åˆ°ç”Ÿäº§ç¯å¢ƒ**
   - å…ˆç”¨æ¨¡å¼ 2 æµ‹è¯•
   - ç¡®è®¤æ— è¯¯åå†ç”¨æ¨¡å¼ 1
   - æˆ–ç›´æ¥ä¿ç•™æ–°ä»“åº“

## æ›´å¤šä¿¡æ¯

å‚è€ƒæ–‡æ¡£ï¼š
- [é…ç½®æŒ‡å—](../docs/configuration.md)
- [æ•…éšœæ’æŸ¥](../docs/troubleshooting.md)
